<template>
  <div class="bill__search-advanced">
    <p-modal :active="visible" @close="handleClose" :title="`Xuất hóa đơn`">
      <template>
        <div class="search">
          <div class="d-flex mb-12 flex-column font-weight-600 ">
            <span> Khoảng thời gian:</span>
            <div class=" date-search  ">
              <p-datepicker
                :format="'dd/mm/yyyy'"
                class="p-input-group input-group"
                @update="selectDate"
                :label="labelDate"
                id="date-search"
                :value="{
                  startDate: filter.start_date,
                  endDate: filter.end_date,
                }"
                :ranges="false"
                @clear="clearSearchDate"
              ></p-datepicker>
            </div>
          </div>
        </div>
        <div class="status">
          <div class="title font-weight-600">Loại phí:</div>
          <div class="list-option">
            <div class="item checkbox-custom">
              <input
                type="checkbox"
                v-model="allSelected"
                @click="checkAll"
                id="all"
              />
              <label for="all">All</label>
              <div
                v-for="(item, i) in option"
                :key="i"
                class="item checkbox-custom"
              >
                <input
                  type="checkbox"
                  :id="item.name"
                  name="status"
                  :value="item.value"
                  v-model="filter.status_arr"
                />
                <label :for="item.name">{{ item.label }}</label>
              </div>
            </div>
          </div>
        </div>
      </template>
      <template slot="footer">
        <div class="note">
          <b>Lưu ý: </b>
          <span
            >Kết quả tìm kiếm sẽ bao gồm các đơn ứng với tùy chọn và khoảng thời
            gian bạn lựa chọn.</span
          >
        </div>
        <div class="d-flex">
          <div class="ml-7">
            <p-button type="primary" @click="handleExport">
              Xuất hóa đơn
            </p-button>
          </div>
        </div>
      </template>
    </p-modal>
  </div>
</template>
<script>
import { date } from '@core/utils/datetime'
export default {
  name: 'ModalSearch',
  props: {
    visible: {
      type: Boolean,
      default: false,
    },
    loadingView: {
      type: Boolean,
      default: false,
    },
    loadingExport: {
      type: Boolean,
      default: false,
    },
    filterPage: {
      type: Object,
      default: () => {},
    },
  },

  data() {
    return {
      filter: {
        status_arr: [],
        search: '',
        start_date: '',
        end_date: '',
        search_by: '',
        page: 1,
        limit: 25,
      },
      labelDate: `Chọn khoảng thời gian`,
      allSelected: false,
      err: false,
      option: [
        {
          name: 'package',
          value: 'package',
          label: 'Phí vận đơn',
        },
        {
          name: 'extra',
          value: 'extra',
          label: 'Phí phát sinh',
        },
      ],
    }
  },
  computed: {},
  created() {},

  methods: {
    handleClose() {
      this.$emit('update:visible', false)
      this.$emit('close')
    },
    selectDate(v) {
      this.err = false
      var month = new Date().getMonth() + 1
      var year = new Date().getFullYear()

      if (v.startDate !== null && v.endDate !== null) {
        const time = v.endDate.getTime() - v.startDate.getTime()
        const diff_days = Math.floor(time / (1000 * 3600 * 24))
        if (
          month - (v.startDate.getMonth() + 1) > 3 ||
          v.startDate.getFullYear() != year
        ) {
          this.$toast.error(
            'Lịch sử tìm kiếm chỉ trong 3 tháng trước đến hiện tại '
          )
          this.err = true
          return
        }
        if (diff_days > 14) {
          this.$toast.error('Giới hạn tìm kiếm chỉ trong vòng 14 ngày')
          this.err = true
          return
        }
      }
      this.filter.start_date = date(v.startDate, 'yyyy-MM-dd')
      this.filter.end_date = date(v.endDate, 'yyyy-MM-dd')
    },
    clearSearchDate() {
      this.filter.end_date = ''
      this.filter.start_date = ''
      this.err = false
    },
    handleExport() {
      if (this.err) return
      if (this.filter.start_date == '' || this.filter.end_date == '') {
        this.$toast.error('Chưa chọn khoảng thời gian')
        this.err = true
        return
      }
      if (this.filter.status_arr.length < 1) {
        this.$toast.error('Chưa chọn trạng thái')
        return
      }

      this.$emit('export', this.filter)
    },
    checkAll() {
      this.filter.status_arr = []
      var checkboxes = document.getElementsByName('status')
      if (!this.allSelected) {
        for (var i = 0, n = checkboxes.length; i < n; i++) {
          this.filter.status_arr.push(checkboxes[i].value)
        }
      }
    },
    handleDeleteSearch() {
      this.filter.search = ''
    },
  },
  watch: {
    'filter.status_arr'() {
      this.allSelected =
        this.filter.status_arr.length == this.option.length ? true : false
    },
    visible: function(val) {
      this.err = false
      if (val) {
        this.filter.start_date = this.filterPage.start_date
        this.filter.end_date = this.filterPage.end_date
      }
    },
  },
}
</script>
